local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "The Rake script",
    LoadingTitle = "Script loading...",
    LoadingSubtitle = "by 助手",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false,
})

local MainTab = Window:CreateTab("玩家增强", nil)
local VisualsTab = Window:CreateTab("视觉辅助", nil)

local InfiniteJumpEnabled = false
local SpeedEnabled = false
local PlayerESPEnabled = false
local RakeESPEnabled = false
local FlareGunESPEnabled = false
local LootboxESPEnabled = false
local FullBrightEnabled = false

local PlayerESPObjects = {}
local ItemESPObjects = {}
local RakeESPObjects = {}
local FullBrightConnection

local currentWalkSpeed = 16
local currentJumpPower = 50

game:GetService("UserInputService").JumpRequest:Connect(function()
    if InfiniteJumpEnabled then
        local player = game:GetService("Players").LocalPlayer
        if player and player.Character then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid:ChangeState("Jumping")
            end
        end
    end
end)

MainTab:CreateToggle({
    Name = "开启无限跳跃",
    CurrentValue = false,
    Callback = function(Value)
        InfiniteJumpEnabled = Value
    end,
})

MainTab:CreateToggle({
    Name = "开启速度调整",
    CurrentValue = false,
    Callback = function(Value)
        SpeedEnabled = Value
        local player = game:GetService("Players").LocalPlayer
        if player and player.Character then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                if Value then
                    humanoid.WalkSpeed = currentWalkSpeed
                else
                    humanoid.WalkSpeed = 16
                end
            end
        end
    end,
})

MainTab:CreateSlider({
    Name = "移动速度",
    Range = {16, 50},
    Increment = 1,
    Suffix = "速度",
    CurrentValue = currentWalkSpeed,
    Callback = function(Value)
        currentWalkSpeed = Value
        if SpeedEnabled then
            local player = game:GetService("Players").LocalPlayer
            if player and player.Character then
                local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = Value
                end
            end
        end
    end,
})

MainTab:CreateSlider({
    Name = "跳跃力量",
    Range = {50, 200},
    Increment = 1,
    Suffix = "力量",
    CurrentValue = currentJumpPower,
    Callback = function(Value)
        currentJumpPower = Value
        local player = game:GetService("Players").LocalPlayer
        if player and player.Character then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.JumpPower = Value
            end
        end
    end,
})

VisualsTab:CreateToggle({
    Name = "游戏全亮",
    CurrentValue = false,
    Callback = function(Value)
        FullBrightEnabled = Value
        if Value then
            FullBrightConnection = game:GetService("RunService").RenderStepped:Connect(function()
                if not FullBrightEnabled then
                    FullBrightConnection:Disconnect()
                    return
                end
                
                local lighting = game:GetService("Lighting")
                lighting.Ambient = Color3.new(1, 1, 1)
                lighting.Brightness = 2
                lighting.GlobalShadows = false
                lighting.OutdoorAmbient = Color3.new(1, 1, 1)
                
                for _, obj in pairs(lighting:GetChildren()) do
                    if obj:IsA("Sky") then
                        obj:Destroy()
                    end
                end
            end)
        else
            if FullBrightConnection then
                FullBrightConnection:Disconnect()
            end
            local lighting = game:GetService("Lighting")
            lighting.Ambient = Color3.new(0.5, 0.5, 0.5)
            lighting.Brightness = 1
            lighting.GlobalShadows = true
            lighting.OutdoorAmbient = Color3.new(0.5, 0.5, 0.5)
        end
    end,
})

local function createBillboardGUI(adornee, text, color)
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP_Billboard"
    billboard.Adornee = adornee
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = 500
    billboard.Parent = game.CoreGui
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = text
    textLabel.TextColor3 = color
    textLabel.TextSize = 12
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.Parent = billboard
    
    return {Billboard = billboard, TextLabel = textLabel}
end

local function updateDistance(espObject, targetPart, name)
    if not espObject or not espObject.TextLabel then return end
    
    local localPlayer = game:GetService("Players").LocalPlayer
    if not localPlayer or not localPlayer.Character then return end
    
    local localRoot = localPlayer.Character:FindFirstChild("HumanoidRootPart")
    local targetRoot = targetPart
    
    if not localRoot or not targetRoot then return end
    
    local distance = (localRoot.Position - targetRoot.Position).Magnitude
    espObject.TextLabel.Text = string.format("%s\n%d studs", name, math.floor(distance))
end

local function addPlayerESP(player)
    if not PlayerESPEnabled or player == game:GetService("Players").LocalPlayer then return end
    
    local function createESP(character)
        if character and not PlayerESPObjects[player] then
            local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
            if not humanoidRootPart then return end
            
            local highlight = Instance.new("Highlight")
            highlight.Name = "PlayerESP"
            highlight.Adornee = character
            highlight.FillColor = Color3.fromRGB(255, 0, 0)
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
            highlight.FillTransparency = 0.3
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = game.CoreGui
            
            local billboard = createBillboardGUI(humanoidRootPart, player.Name, Color3.fromRGB(255, 0, 0))
            
            PlayerESPObjects[player] = {
                Highlight = highlight,
                Billboard = billboard.Billboard,
                TextLabel = billboard.TextLabel,
                Character = character
            }
            
            coroutine.wrap(function()
                while PlayerESPObjects[player] and character and character.Parent do
                    updateDistance(billboard, humanoidRootPart, player.Name)
                    wait(0.2)
                end
            end)()
        end
    end
    
    if player.Character then
        createESP(player.Character)
    end
    
    player.CharacterAdded:Connect(createESP)
end

VisualsTab:CreateToggle({
    Name = "显示玩家位置",
    CurrentValue = false,
    Callback = function(Value)
        PlayerESPEnabled = Value
        if Value then
            for _, player in ipairs(game:GetService("Players"):GetPlayers()) do
                addPlayerESP(player)
            end
            game:GetService("Players").PlayerAdded:Connect(addPlayerESP)
        else
            for player, espObject in pairs(PlayerESPObjects) do
                if espObject.Highlight then espObject.Highlight:Destroy() end
                if espObject.Billboard then espObject.Billboard:Destroy() end
                PlayerESPObjects[player] = nil
            end
        end
    end,
})

VisualsTab:CreateToggle({
    Name = "显示RAKE位置",
    CurrentValue = false,
    Callback = function(Value)
        RakeESPEnabled = Value
        if Value then
            scanForRakes()
        else
            removeRakeESP()
        end
    end,
})

VisualsTab:CreateToggle({
    Name = "显示信号枪位置",
    CurrentValue = false,
    Callback = function(Value)
        FlareGunESPEnabled = Value
        if Value then
            scanForFlareGuns()
        else
            removeESPByType("FlareGun")
        end
    end,
})

VisualsTab:CreateToggle({
    Name = "显示战利品箱位置",
    CurrentValue = false,
    Callback = function(Value)
        LootboxESPEnabled = Value
        if Value then
            scanForLootboxes()
        else
            removeESPByType("Lootbox")
        end
    end,
})

function scanForRakes()
    if not RakeESPEnabled then return end
    
    for _, npc in pairs(workspace:GetChildren()) do
        if npc:IsA("Model") and (string.find(string.lower(npc.Name), "rake")) then
            addRakeESP(npc)
        end
    end
end

function addRakeESP(rakeModel)
    if RakeESPObjects[rakeModel] then return end

    local primaryPart = rakeModel.PrimaryPart or rakeModel:FindFirstChild("HumanoidRootPart")
    if not primaryPart then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = "RakeESP"
    highlight.Adornee = rakeModel
    highlight.FillColor = Color3.fromRGB(139, 0, 0)
    highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
    highlight.FillTransparency = 0.3
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = game.CoreGui

    local billboard = createBillboardGUI(primaryPart, "RAKE", Color3.fromRGB(255, 0, 0))
    
    RakeESPObjects[rakeModel] = {
        Highlight = highlight,
        Billboard = billboard.Billboard,
        TextLabel = billboard.TextLabel,
        Model = rakeModel
    }
    
    coroutine.wrap(function()
        while RakeESPObjects[rakeModel] and rakeModel.Parent do
            updateDistance(billboard, primaryPart, "RAKE")
            wait(0.2)
        end
    end)()
end

function removeRakeESP()
    for rakeModel, espObject in pairs(RakeESPObjects) do
        if espObject.Highlight then espObject.Highlight:Destroy() end
        if espObject.Billboard then espObject.Billboard:Destroy() end
        RakeESPObjects[rakeModel] = nil
    end
end

function scanForFlareGuns()
    if not FlareGunESPEnabled then return end
    
    for _, item in pairs(workspace:GetChildren()) do
        if item:IsA("Model") and (string.find(string.lower(item.Name), "flare") or string.find(string.lower(item.Name), "signal")) then
            addItemESP(item, "信号枪", Color3.fromRGB(255, 255, 0))
        end
    end
end

function scanForLootboxes()
    if not LootboxESPEnabled then return end
    
    for _, item in pairs(workspace:GetChildren()) do
        if item:IsA("Model") and (string.find(string.lower(item.Name), "lootbox") or string.find(string.lower(item.Name), "loot") or string.find(string.lower(item.Name), "crate")) then
            addItemESP(item, "战利品箱", Color3.fromRGB(0, 255, 0))
        end
    end
end

function addItemESP(itemModel, itemType, color)
    if ItemESPObjects[itemModel] then return end

    local primaryPart = itemModel.PrimaryPart or itemModel:FindFirstChild("Handle") or itemModel:FindFirstChildWhichIsA("BasePart")
    if not primaryPart then return end

    local highlight = Instance.new("Highlight")
    highlight.Name = itemType .. "ESP"
    highlight.Adornee = itemModel
    highlight.FillColor = color
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.FillTransparency = 0.3
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = game.CoreGui

    local billboard = createBillboardGUI(primaryPart, itemType, color)
    
    ItemESPObjects[itemModel] = {
        Highlight = highlight,
        Billboard = billboard.Billboard,
        TextLabel = billboard.TextLabel,
        Type = itemType,
        Model = itemModel
    }
    
    coroutine.wrap(function()
        while ItemESPObjects[itemModel] and itemModel.Parent do
            updateDistance(billboard, primaryPart, itemType)
            wait(0.2)
        end
    end)()
end

function removeItemESP(itemModel)
    local espObject = ItemESPObjects[itemModel]
    if espObject then
        if espObject.Highlight then espObject.Highlight:Destroy() end
        if espObject.Billboard then espObject.Billboard:Destroy() end
        ItemESPObjects[itemModel] = nil
    end
end

function removeESPByType(itemType)
    for itemModel, espObject in pairs(ItemESPObjects) do
        if espObject.Type == itemType then
            removeItemESP(itemModel)
        end
    end
end

game:GetService("Players").PlayerRemoving:Connect(function(player)
    if PlayerESPObjects[player] then
        if PlayerESPObjects[player].Highlight then PlayerESPObjects[player].Highlight:Destroy() end
        if PlayerESPObjects[player].Billboard then PlayerESPObjects[player].Billboard:Destroy() end
        PlayerESPObjects[player] = nil
    end
end)

game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function(character)
    character:WaitForChild("Humanoid")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        if SpeedEnabled then
            humanoid.WalkSpeed = currentWalkSpeed
        else
            humanoid.WalkSpeed = 16
        end
        humanoid.JumpPower = currentJumpPower
    end
end)

local player = game:GetService("Players").LocalPlayer
if player and player.Character then
    local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        if SpeedEnabled then
            humanoid.WalkSpeed = currentWalkSpeed
        else
            humanoid.WalkSpeed = 16
        end
        humanoid.JumpPower = currentJumpPower
    end
end

game:GetService("RunService").Heartbeat:Connect(function()
    if RakeESPEnabled then
        scanForRakes()
    end
    if FlareGunESPEnabled then
        scanForFlareGuns()
    end
    if LootboxESPEnabled then
        scanForLootboxes()
    end
end)

-- 在脚本底部添加备注
VisualsTab:CreateSection("备注")
VisualsTab:CreateParagraph({Title = "", Content = "The script creator is: CN_154LH"})

Rayfield:Notify({
    Title = "脚本加载成功",
    Content = "请根据需要开启功能",
    Duration = 5,
})